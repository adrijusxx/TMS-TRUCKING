name: Build and Deploy to AWS EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        env:
          npm_config_legacy_peer_deps: true
      
      - name: Generate Prisma Client
        run: npm run db:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Build Next.js
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_BASE_PATH: ${{ secrets.NEXT_PUBLIC_BASE_PATH || '' }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          NODE_OPTIONS: '--max-old-space-size=6144'
      
      - name: Create deployment archive
        run: |
          tar -czf deploy.tar.gz \
            .next \
            package.json \
            package-lock.json \
            node_modules/.prisma \
            prisma/schema.prisma \
            ecosystem.config.js \
            next.config.js \
            public \
            scripts/start-app-with-secrets.sh \
            scripts/run-migration-with-secrets.sh \
            scripts/assign-super-admin.js
      
      - name: Deploy to AWS EC2 via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: 22
          timeout: 300s
          source: "deploy.tar.gz"
          target: "/home/ec2-user/tms/"
      
      - name: Extract, update, and restart on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            set -e
            cd /home/ec2-user/tms
            
            echo "Extracting deployment archive..."
            tar -xzf deploy.tar.gz
            
            echo "Making startup script executable..."
            chmod +x scripts/start-app-with-secrets.sh scripts/run-migration-with-secrets.sh || true
            
            echo "Cleaning up old Prisma config file (if exists)..."
            # Remove prisma.config.ts if it exists (incompatible with Prisma 6)
            rm -f prisma.config.ts || true
            
            echo "Checking memory and swap..."
            free -h
            # Check if swap exists and create if not (prevent OOM on small instances)
            SWAP_SIZE=$(free -m | awk '/^Swap:/ {print $2}')
            if [ "$SWAP_SIZE" -gt 0 ]; then
                echo "Swap exists ($SWAP_SIZE MB)."
            else
                echo "No swap found. Creating 2GB swap file..."
                sudo fallocate -l 2G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo "Swap created successfully."
                free -h
            fi
            
            echo "Installing production dependencies..."
            npm ci --production --ignore-scripts --legacy-peer-deps
            
            echo "Installing Prisma CLI for client generation..."
            # Remove any existing Prisma installation to avoid version conflicts
            npm uninstall prisma 2>/dev/null || true
            # Install the exact Prisma version from package.json (6.19.0) as dev dependency
            npm install prisma@6.19.0 --legacy-peer-deps --save-dev --force
            
            echo "Verifying Prisma version..."
            npx prisma --version | head -1
            
            echo "Generating Prisma Client..."
            # Note: In production, DATABASE_URL comes from AWS Secrets Manager
            # This is just for Prisma Client generation
            # Use explicit version to ensure we're using 6.19.0
            npx prisma@6.19.0 generate
            
            echo "Running database migrations..."
            ./scripts/run-migration-with-secrets.sh || echo "Migration skipped or failed"
            
            echo "Restarting application with PM2..."
            pm2 restart tms || pm2 start ecosystem.config.js
            
            echo "Cleaning up..."
            rm -f deploy.tar.gz
            
            echo "âœ… Deployment complete!"
# Trigger rebuild 12/29/2025 18:48:00
